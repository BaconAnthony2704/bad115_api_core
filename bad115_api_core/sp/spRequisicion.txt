CREATE PROCEDURE spRequisicion_ver
@p_id AS BIGINT=NULL
AS
BEGIN
	IF EXISTS(SELECT * FROM REQUISICION WHERE IDREQUISICION=@p_id)
		SELECT * FROM REQUISICION WHERE IDREQUISICION=@p_id
	ELSE
		SELECT * FROM REQUISICION
END

CREATE PROCEDURE spRequisicion_guardar
	@p_ESTADO AS INT  =null    ,
	@p_FECHAINGRESADA AS DATETIME=null,
	@p_FECHALIMITE AS DATETIME      ,
	@p_ID_SUCURSAL AS INT  =null    ,
	@p_ID_USUARIO AS INT   =-1,
	@p_IDREQUISICION AS INT      ,
	@p_USUARIOENCARGADO AS VARCHAR  ( 250 ) = NULL 
AS
BEGIN

	 IF (@p_IDREQUISICION=-1)
	BEGIN
		INSERT INTO REQUISICION (
		 ESTADO ,
		 FECHAINGRESADA ,
		 FECHALIMITE ,
		 ID_SUCURSAL ,
		 ID_USUARIO ,
		 USUARIOENCARGADO 
		) VALUES (
		case when 
		 @p_ESTADO is null then 1 else @p_ESTADO end, 
		 case when 
		 @p_FECHAINGRESADA is null then GETDATE() else @p_FECHAINGRESADA end, 
		 @p_FECHALIMITE,
		 case when 
		 @p_ID_SUCURSAL is null then -1 else @p_ID_SUCURSAL end, 
		 @p_ID_USUARIO, 
		 @p_USUARIOENCARGADO 
		)
		select * from REQUISICION r where r.IDREQUISICION=SCOPE_IDENTITY()
	END

	ELSE
	BEGIN
		UPDATE REQUISICION 
		SET 
		ESTADO=@p_ESTADO,
		FECHAINGRESADA=@p_FECHAINGRESADA,
		FECHALIMITE=@p_FECHALIMITE,
		ID_SUCURSAL=@p_ID_SUCURSAL,
		ID_USUARIO=@p_ID_USUARIO,
		USUARIOENCARGADO=@p_USUARIOENCARGADO
		WHERE IDREQUISICION=@p_IDREQUISICION

		select * from REQUISICION r where r.IDREQUISICION=@p_ID_SUCURSAL

	END
END